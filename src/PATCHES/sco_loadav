From blm%6sigma.UUCP%polari.UUCP@sumax.seattleu.edu Tue Feb 25 01:15:22 1992
Received: from sumax.seattleu.edu by immd4.informatik.uni-erlangen.de  with SMTP (5.64+/7.3a-FAU)
	id AA08420; Tue, 25 Feb 92 01:15:09 +0100
Received: by sumax.seattleu.edu id AA02117
  (5.65a/IDA-1.4.2 for jnweiger@immd4.informatik.uni-erlangen.de); Mon, 24 Feb 92 16:17:59 -0800
Received: by polari.uucp (smail2.5)
	id AA05508; 24 Feb 92 12:28:14 PST (Mon)
From: blm@6sigma.UUCP (Brian L. Matthews)
X-Mailer: SCO System V Mail (version 3.2)
To: jnweiger@immd4.informatik.uni-erlangen.de
Subject: Screen 3.2 changes
Date: Mon, 24 Feb 92 12:08:44 PST
Message-Id:  <9202241208.aa22794@6sigma.UUCP>
Status: OR


Juergen,

Attached are some changes to the excellent screen 3.2.  These changes
mostly fall into three categories:

1.  A couple of bug fixes having to do with attribute handling in the
    status line.

2.  Some minor typo fixes in error messages and the addition of some
    more all important nethack error messages :-).

3.  The addition of code to do load averages for SCO UNIX.

The changes are in the form of context diffs attached to the end of
this message.  Here is a more detailed description of each change:

ansi.c:

1.  On a terminal with an extra status line, the attribute was being
    set to nothing instead of standout.

2.  On a terminal with an extra status line, once the message is displayed,
    standout mode has to be exited.

fileio.c:

1.  Add an #ifdef for LOADAV_KERNEL and LOADAV_SYMBOL, instead of the
    long string of #if/#else for different system types.  I would
    recomment changing each config.h to define these symbols if they
    support load averages.  This way, the code in fileio.c is easier
    to follow, and new systems can be added without modifying fileio.c,
    no matter where their kernel is or what symbol is used to maintain
    the load average.

2.  SCO UNIX uses 4 shorts to maintain the load average, so add #ifdef
    for this.

screen.c:

The changes here are adding periods to the end of sentences, fixing one
grammatical error, adding nethack error messages, and adding code to
handle SCOs load average.

screen.h:

1.  Make the LOADAV symbol depend upon the presence of LOADAV_KERNEL and
    LOADAV_SYMBOL.

2.  Change a nethack message to match the actual message given in nethack.

config/config.sco32:

1.  Added #defines for load average.

2.  Added comments indicating what symbols must be #undef'd to work
    without the crypt library.

Thats it.  I hope you find these useful.  Let me know if you have any
questions, and thanks for an excellent program!

Brian L. Matthews
blm@6sceng.UUCP

The diffs:

*** orig/ansi.c	Fri Feb 21 16:53:29 1992
--- ansi.c	Sat Feb 22 16:24:18 1992
***************
*** 3181,3192 ****
        else
  	{
  	  debug("HS:");
!           SaveSetAttr(0, ASCII);
  	  InsertMode(0);
  	  CPutStr(TS, 0);
  	  printf("%s", msg);
  	  PutStr(FS);
  	}
        (void) fflush(stdout);
        (void) time(&TimeDisplayed);
      }
--- 3181,3193 ----
        else
  	{
  	  debug("HS:");
!           SaveSetAttr(A_SO, ASCII);
  	  InsertMode(0);
  	  CPutStr(TS, 0);
  	  printf("%s", msg);
  	  PutStr(FS);
  	}
+       SaveSetAttr(0, ASCII);
        (void) fflush(stdout);
        (void) time(&TimeDisplayed);
      }
*** orig/fileio.c	Fri Feb 21 15:50:36 1992
--- fileio.c	Fri Feb 21 16:01:14 1992
***************
*** 75,107 ****
  #  include <nlist.h>
  
  static char KmemName[] = "/dev/kmem";
! #  if defined(_SEQUENT_) || defined(MIPS) || defined(SVR4) || defined(ISC) || defined (sgi)
! static char UnixName[] = "/unix";
! #  else
! #   ifdef sequent
! static char UnixName[] = "/dynix";
! #   else
! #    ifdef hpux
! static char UnixName[] = "/hp-ux";
! #    else
! #     ifdef xelos
! static char UnixName[] = "/xelos";
! #     else
! static char UnixName[] = "/vmunix";
! #     endif /* xelos */
! #    endif /* hpux */
! #   endif /* sequent */
! #  endif /* _SEQUENT_ ... */
  
! #  ifdef alliant
! static char AvenrunSym[] = "_Loadavg";
! #  else
! #   if defined(hpux) || defined(_SEQUENT_) || defined(SVR4) || defined(ISC) || defined(sgi)
! static char AvenrunSym[] = "avenrun";
! #   else
! static char AvenrunSym[] = "_avenrun";
! #   endif
! #  endif /* alliant */
  static struct nlist nl[2];
  int avenrun;
  static kmemf;
--- 75,87 ----
  #  include <nlist.h>
  
  static char KmemName[] = "/dev/kmem";
! #  ifdef LOADAV_KERNEL
! static char UnixName[] = LOADAV_KERNEL;
! #  endif /* UNIX_NAME */
  
! #  ifdef LOADAV_SYMBOL
! static char AvenrunSym[] = LOADAV_SYMBOL;
! #  endif /* LOADAV_NAME */
  static struct nlist nl[2];
  int avenrun;
  static kmemf;
***************
*** 111,117 ****
--- 91,101 ----
  #   ifdef LOADAV_4LONGS
  long loadav[4];
  #   else
+ #    ifdef LOADAV_4SHORTS
+ short loadav[4];
+ #    else
  double loadav[3];
+ #    endif
  #   endif
  #  endif
  # else /* NeXT */
*** orig/screen.c	Fri Feb 21 16:07:36 1992
--- screen.c	Sat Feb 22 16:24:37 1992
***************
*** 2666,2675 ****
  # ifdef LOADAV_4LONGS
  extern long loadav[4];
  # else
! #  ifdef LOADAV_NEXT
! extern float loadav;
  #  else
  extern double loadav[3];
  #  endif
  # endif
  #endif
--- 2703,2716 ----
  # ifdef LOADAV_4LONGS
  extern long loadav[4];
  # else
! #  ifdef LOADAV_4SHORTS
! extern short loadav[4];
  #  else
+ #   ifdef LOADAV_NEXT
+ extern float loadav;
+ #   else
  extern double loadav[3];
+ #   endif
  #  endif
  # endif
  #endif
***************
*** 2692,2698 ****
    if (avenrun && GetAvenrun())
      {
        p = buf + strlen(buf);
! # ifdef LOADAV_3LONGS
        sprintf(p, " %2.2f %2.2f %2.2f", (double) loadav[0] / FSCALE,
  	      (double) loadav[1] / FSCALE, (double) loadav[2] / FSCALE);
  # else
--- 2733,2739 ----
    if (avenrun && GetAvenrun())
      {
        p = buf + strlen(buf);
! #if defined(LOADAV_3LONGS) || defined(LOADAV_4SHORTS)
        sprintf(p, " %2.2f %2.2f %2.2f", (double) loadav[0] / FSCALE,
  	      (double) loadav[1] / FSCALE, (double) loadav[2] / FSCALE);
  # else
*** orig/screen.h     Fri Feb 21 15:56:08 1992
--- screen.h  Fri Feb 21 16:45:39 1992
***************
*** 117,124 ****
  #  define LOGINDEFAULT 0
  #endif
  
! #if defined(LOADAV_3DOUBLES) || defined(LOADAV_3LONGS) ||\
!     defined(LOADAV_4LONGS) || defined(LOADAV_NEXT)
  #  define LOADAV
  #endif
  
--- 117,123 ----
  #  define LOGINDEFAULT 0
  #endif
  
! #if defined(LOADAV_KERNEL) && defined(LOADAV_SYMBOL)
  #  define LOADAV
  #endif
  
*** orig/config/config.sco32	Fri Feb 21 15:59:35 1992
--- config/config.sco32	Mon Feb 24 11:41:03 1992
***************
*** 7,12 ****
--- 7,17 ----
   * directory.  I also have TCP/IP installed, but I do not think that this has
   * any effect on compilation.  I also installed the crypt libraries sent to me
   * by SCO.  Not sure what one would do without them.
+  *
+  * Changes by Brian L. Matthews (blm@6sceng.UUCP):
+  * - Added definitions of LOADAV_4SHORTS, LOADAV_KERNEL and LOADAV_SYMBOL so
+  *   CTRL-A t displays load average.
+  * - Added comments on what to undefined if you don't have the crypt library.
   ********************************************************** 
   * $Id$ FAU
   */
***************
*** 26,34 ****
  #undef USRLIMIT
  #undef LOCKPTY
  #define NOREUID
! #define LOADAV_3DOUBLES
! #undef  LOADAV_3LONGS
! #undef  LOADAV_4LONGS
  #undef GETTTYENT
  #undef NFS_HACK
  #undef LOCALSOCKDIR
--- 31,40 ----
  #undef USRLIMIT
  #undef LOCKPTY
  #define NOREUID
! #define LOADAV_4SHORTS
! #define LOADAV_KERNEL "/unix"
! #define LOADAV_SYMBOL "avenrun"
! #define FSCALE 256.0
  #undef GETTTYENT
  #undef NFS_HACK
  #undef LOCALSOCKDIR
***************
*** 44,51 ****
  #undef TOPSTAT
  #define USEVARARGS
  #define NAMEDPIPE
! #define LOCK
! #define PASSWORD
  #define COPY_PASTE
  #define REMOTE_DETACH
  #define POW_DETACH
--- 50,57 ----
  #undef TOPSTAT
  #define USEVARARGS
  #define NAMEDPIPE
! #define LOCK		/* Undef this... */
! #define PASSWORD	/* and this if you don't have the crypt library */
  #define COPY_PASTE
  #define REMOTE_DETACH
  #define POW_DETACH

