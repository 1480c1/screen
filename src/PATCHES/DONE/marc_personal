--- 1.1.2.2	1992/03/09 23:42:33+++ fileio.c	1992/06/05 03:04:19@@ -2089,6 +2089,7 @@   register slot_t slot;   char *line;   struct utmp u;+  int saved_ut; # ifdef UTHOST #  ifdef _SEQUENT_   char host[100+5];@@ -2110,6 +2111,11 @@   InitUtmp(); # endif /* apollo */ +  bzero((char *) &u, sizeof u);+  if (saved_ut = bcmp((char *) &wi->savut, (char *) &u, sizeof u))+    /* restore original, of which we will adopt all fields but ut_host */+    bcopy((char *) &wi->savut, (char *) &u, sizeof u);+ # ifdef UTHOST   host[sizeof(host)-5] = '\0'; #  ifdef _SEQUENT_@@ -2151,51 +2157,46 @@   debug1("rlogin hostname: '%s'\n", host);   sprintf(host + strlen(host), ":S.%c", '0' + displaynumber);   debug1("rlogin hostname: '%s'\n", host);++  strncpy(u.ut_host, host, sizeof(u.ut_host)); # endif /* UTHOST */ -  line = stripdev(wi->tty);-  bzero((char *) &u, sizeof u);+  if (!saved_ut)+    { /* make new utmp from scratch */+      line = stripdev(wi->tty);  # ifdef GETUTENT #  ifdef _SEQUENT_-  if (ut_add_user(LoginName, slot, wi->wpid, host)==0)+      if (ut_add_user(LoginName, slot, wi->wpid, host)==0) #  else /* _SEQUENT_ */-  strncpy(u.ut_user, LoginName, sizeof(u.ut_user));+      strncpy(u.ut_user, LoginName, sizeof(u.ut_user)); #   ifdef sgi-  strncpy(u.ut_id, line + 3, sizeof(u.ut_id));+      strncpy(u.ut_id, line + 3, sizeof(u.ut_id)); #   else /* sgi */-  strncpy(u.ut_id, line + strlen(line) - 2, sizeof(u.ut_id));+      strncpy(u.ut_id, line + strlen(line) - 2, sizeof(u.ut_id)); #   endif /* sgi */-  strncpy(u.ut_line, line, sizeof(u.ut_line));-  u.ut_pid = wi->wpid;-  u.ut_type = USER_PROCESS;-#   ifdef SVR4-    (void) time(&u.ut_tv.tv_sec);-    u.ut_tv.tv_usec=0;-#   else /* SVR4 */-    (void) time(&u.ut_time);-#   endif /* SVR4 */-#   ifdef UTHOST-  strncpy(u.ut_host, host, sizeof(u.ut_host));-#   endif /* UTHOST */+      strncpy(u.ut_line, line, sizeof(u.ut_line));+      u.ut_pid = wi->wpid;+      u.ut_type = USER_PROCESS;+      (void) time(&u.ut_time);+    } /* bcmp savut */   if (pututline(&u) == 0) #  endif /* _SEQUENT_ */ # else	/* GETUTENT */-  strncpy(u.ut_line, line, sizeof(u.ut_line));-  strncpy(u.ut_name, LoginName, sizeof(u.ut_name));-#  ifdef UTHOST-  strncpy(u.ut_host, host, sizeof(u.ut_host));-#  endif /* UTHOST */+      strncpy(u.ut_line, line, sizeof(u.ut_line));+      strncpy(u.ut_name, LoginName, sizeof(u.ut_name)); #  ifdef MIPS-  u.ut_type = 7; /* USER_PROCESS */-  strncpy(u.ut_id, line + 3, 4);+      u.ut_type = 7; /* USER_PROCESS */+      strncpy(u.ut_id, line + 3, 4); #  endif /* MIPS */-  (void) time(&u.ut_time);+      (void) time(&u.ut_time);+    } /* bcmp savut */ #  ifdef sequent-  /*-   * call sequent undocumented routine to count logins and -   * add utmp entry if possible -   */+      /*+       * call sequent undocumented routine to count logins and +       * add utmp entry if possible +       */+ICI   if (add_utmp(slot, &u) == -1) #  else /* sequent */   (void) lseek(utmpf, (off_t) (slot * sizeof u), 0);@@ -2324,6 +2325,7 @@ #  ifdef _SEQUENT_   if (ut_delete_user(slot, uu->ut_pid, 0, 0) == 0) #  else /* _SEQUENT_ */+  bcopy((char *)uu, (char *)&wi->savut, sizeof(wi->savut));   uu->ut_type = DEAD_PROCESS;   uu->ut_exit.e_termination = 0;   uu->ut_exit.e_exit= 0;@@ -2338,11 +2340,20 @@       Msg(errno, "cannot read %s?", UTMPFILE);       sleep(1);     }+  bcopy((char *)up, (char *)&wi->savut, sizeof(wi->savut));   (void) lseek(utmpf, (off_t) (slot * sizeof u), 0);   bzero(up->ut_name, sizeof(u.ut_name));-  bzero(up->ut_host, sizeof(u.ut_host+  bzero(up->ut_host, sizeof(u.ut_host));   if (write(utmpf, (char *)up, sizeof u) != sizeof u) #  else /* apollo */+  if (read(utmpf, (char *) &wi->savut, sizeof(wi->savut)) != sizeof u)+    {+      bzero(&wi->savut, sizeof(wi->savut));+      DeadlyMsg = 0;+      Msg(errno, "cannot read %s?", UTMPFILE);+      sleep(1);+    }+  (void) lseek(utmpf, (off_t) (slot * sizeof u), 0);   if (write(utmpf, (char *) &u, sizeof u) != sizeof u) #  endif /* apollo */ # endif /* GETUTENT */--- 1.1.2.1	1992/03/09 03:23:55+++ patchlevel.h	1992/05/27 02:34:16@@ -32,7 +32,7 @@  */  /****************************************************************- * $Header$ + * $Header$   *  * patchlevel.h: Our life story.  *   8.7.91 -- 3.00.01 -wipe and a 'setenv TERM dumb' bugfix.--- 1.1.2.3	1992/04/08 13:25:34+++ screen.h	1992/06/05 03:04:38@@ -191,14 +191,16 @@   typedef int slot_t; #endif -#if !defined(BSD) && !defined(sequent) && !defined(NeXT)+#ifdef SYSV /* jw. */ # define index strchr # define rindex strrchr-#endif--#ifdef SYSV /* jw. */ # define bzero(poi,len) memset(poi,0,len)+# define bcopy(s,d,len) memmove(d,s,len)+# define bcmp memcmp # define killpg(pgrp,sig) kill( -(pgrp), sig)+# ifdef POSIX+#  define signal sigset	/* reliable signals */+# endif #endif  #if defined(_POSIX_SOURCE) && defined(ISC)@@ -207,6 +209,36 @@ # endif #endif +#ifdef UTMPOK+# ifdef SVR4+#  include <utmpx.h>+#  define UTMPFILE	UTMPX_FILE+#  define utmp		utmpx+#  undef  ut_time+#  define ut_time	ut_xtime+#  define getutent	getutxent+#  define getutid	getutxid+#  define getutline	getutxline+#  define pututline	pututxline+#  define setutent	setutxent+#  define endutent	endutxent+# else /* SVR4 */+#  include <utmp.h>+# endif /* SVR4 */+#endif++#ifndef UTMPFILE+# ifdef UTMP_FILE+#  define UTMPFILE     UTMP_FILE+# else+#  ifdef BSDI+#   define UTMPFILE    "/var/run/utmp"+#  else+#   define UTMPFILE     "/etc/utmp"+#  endif /* BSDI */+# endif+#endif+ /* here comes my own Free: jw. */ #define Free(a) {if ((a) == 0) abort(); else free((void *)(a)); (a)=0;} @@ -278,6 +310,9 @@   int args[MAXARGS];   int NumArgs;   slot_t slot;+#if defined (UTMPOK) && !defined(_SEQUENT_)+  struct utmp savut;+#endif /* UTMPOK */   char **image;   char **attr;   char **font;@@ -545,34 +580,6 @@ #ifdef hpux # define setreuid(ruid, euid) setresuid(ruid, euid, -1) # define setregid(rgid, egid) setresgid(rgid, egid, -1)-#endif--#ifdef UTMPOK-# ifdef SVR4-#  include <utmpx.h>-#  define UTMPFILE     UTMPX_FILE-#  define utmp         utmpx-#  define getutent     getutxent-#  define getutid      getutxid-#  define getutline    getutxline-#  define pututline    pututxline-#  define setutent     setutxent-#  define endutent     endutxent-# else /* SVR4 */-#  include <utmp.h>-# endif /* SVR4 */-#endif--#ifndef UTMPFILE-# ifdef UTMP_FILE-#  define UTMPFILE     UTMP_FILE-# else-#  ifdef BSDI-#   define UTMPFILE    "/var/run/utmp"-#  else-#   define UTMPFILE     "/etc/utmp"-#  endif /* BSDI */-# endif #endif  #if !defined(SYSV) || defined(sun) || defined(RENO) || defined(xelos)--- 1.1	1992/06/05 02:11:41+++ config/config.rs6000	1992/06/05 02:11:58@@ -34,7 +34,6 @@ # endif #endif #define USEBCOPY-#define bcopy(s, d, l) memmove(d, s, l) /* bcopy() by Marc Boucher */ #undef TOPSTAT #define USEVARARGS #define NAMEDPIPE--- 1.1.2.1	1992/03/09 03:23:55+++ config/config.svr4	1992/06/05 02:14:53@@ -38,8 +38,6 @@ # endif #endif #define USEBCOPY-#define bcopy(s, d, l) memmove(d, s, l) /* special SVR4 entry */-#define signal sigset                  /* for reliable signals */ #undef TOPSTAT #define USEVARARGS #define NAMEDPIPE